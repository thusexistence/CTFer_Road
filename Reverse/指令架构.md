# 指令架构、指令集和 ABI 的知识整理

## 1. 什么是指令架构（ISA，Instruction Set Architecture）？

指令架构（ISA）是处理器硬件与软件之间的接口，定义了处理器支持的基本功能和操作。它是处理器设计的基础。

### **指令架构的主要内容**
| **概念**         | **解释**                                                                                     |
|------------------|---------------------------------------------------------------------------------------------|
| **指令集**       | 定义处理器支持的所有指令（如加法、减法、跳转等）。                                           |
| **寄存器**       | 定义寄存器的数量、位宽及用途（如通用寄存器、栈指针、程序计数器等）。                           |
| **内存模型**     | 定义处理器如何访问内存（如寻址模式、虚拟地址与物理地址的映射等）。                             |
| **数据类型**     | 定义处理器支持的基本数据类型（如整数、浮点数、向量等）及其宽度（如 8 位、16 位、32 位等）。     |
| **中断和异常**   | 定义处理器如何响应硬件中断或软件异常。                                                       |

### **指令架构的分类**
| **架构类型**     | **解释**                                                                                     |
|------------------|---------------------------------------------------------------------------------------------|
| **CISC**         | **复杂指令集计算机**，如 x86 架构，指令多样、功能复杂，每条指令可能执行多个操作。               |
| **RISC**         | **精简指令集计算机**，如 ARM 架构，指令简单高效，易于实现流水线和并行化。                     |
| **VLIW**         | **超长指令字架构**，如 Itanium，多个操作组合在一条指令中，依赖编译器优化。                     |

---

## 2. 什么是指令集？

指令集是指处理器支持的所有指令的集合，它是指令架构（ISA）的核心部分，用于定义处理器能够执行的所有操作。

### **指令集的作用**
- 定义了如何对数据进行操作（如加法、减法、逻辑运算等）。
- 定义了处理器如何与内存交互（如加载数据、存储数据）。
- 定义了控制程序流的方式（如条件跳转、函数调用等）。

### **常见指令集**
| **指令集**       | **描述**                                                                                     | **应用场景**                      |
|------------------|---------------------------------------------------------------------------------------------|-----------------------------------|
| **x86**          | 经典 32 位指令集，广泛应用于桌面计算机和服务器。                                             | 台式机、老旧系统                  |
| **x86-64**       | x86 的 64 位扩展指令集，向下兼容 x86。                                                      | 现代计算机、服务器、桌面应用      |
| **ARM**          | 低功耗 RISC 指令集，广泛应用于移动设备和嵌入式系统。                                         | 手机、平板、嵌入式设备            |
| **MIPS**         | RISC 指令集，历史悠久，多用于嵌入式系统和教育领域。                                           | 嵌入式系统、网络设备              |
| **RISC-V**       | 开源 RISC 指令集，灵活可扩展，逐渐应用于高性能计算和嵌入式领域。                               | 嵌入式系统、高性能计算             |
| **Itanium (IA-64)** | VLIW 架构的指令集，由 Intel 推出，但市场接受度有限。                                       | 专业服务器、特殊场景              |

### **指令集的组成**
| **部分**         | **内容**                                                                                     |
|------------------|---------------------------------------------------------------------------------------------|
| **算术运算指令** | 加减乘除、按位操作等（如 `ADD`, `SUB`, `AND`, `OR`）。                                       |
| **数据传输指令** | 数据加载、存储和移动（如 `MOV`, `LD`, `ST`）。                                               |
| **控制流指令**   | 跳转、函数调用和返回（如 `JMP`, `CALL`, `RET`）。                                            |
| **系统指令**     | 处理器控制和中断（如 `HLT`, `INT`）。                                                       |

---

## 3. 什么是 ABI（Application Binary Interface，应用二进制接口）？

ABI 是操作系统与程序之间的接口，定义了程序如何使用处理器资源和操作系统功能。ABI 的作用是确保程序在不同硬件和操作系统环境中能够正确运行。

### **ABI 的组成**
| **部分**             | **描述**                                                                                 |
|----------------------|-----------------------------------------------------------------------------------------|
| **调用约定（Calling Convention）** | 定义函数参数如何传递、返回值如何传递、哪些寄存器需要保存。                                   |
| **二进制文件格式**   | 定义可执行文件和库的结构（如 ELF、PE）。                                                   |
| **系统调用接口**     | 定义程序如何与操作系统交互（如系统调用编号）。                                             |

---

### **4. ABI 的调用约定**

调用约定是 ABI 的核心部分，它定义了函数调用时的规则，包括参数传递、返回值和栈的管理。

| **架构**         | **调用约定**              | **参数传递方式**                                               | **返回值方式**          |
|------------------|--------------------------|----------------------------------------------------------------|-------------------------|
| **x86 (32 位)**   | cdecl                   | 参数从右到左压入栈，调用者负责清理栈                           | 返回值存储在 `EAX` 中   |
| **x86-64 (64 位)**| System V AMD64 ABI      | 前 6 个整数参数通过寄存器（`RDI`, `RSI`, `RDX`, ...）传递，其余通过栈传递 | 返回值存储在 `RAX` 中   |
| **ARM (32 位)**   | AAPCS                   | 前 4 个参数通过寄存器（`R0-R3`）传递，其余通过栈传递            | 返回值存储在 `R0` 中    |
| **ARM64 (64 位)** | AAPCS64                 | 前 8 个参数通过寄存器（`X0-X7`）传递，其余通过栈传递            | 返回值存储在 `X0` 中    |

---

## 5. 文件格式在 ABI 中的作用

### **常见的二进制文件格式**
| **文件格式**      | **描述**                                                                                     | **适用平台**                     |
|------------------|---------------------------------------------------------------------------------------------|---------------------------------|
| **ELF**          | Executable and Linkable Format，是 Linux 和类 Unix 系统的标准二进制文件格式。                  | Linux, Android, BSD            |
| **PE**           | Portable Executable Format，是 Windows 操作系统的标准二进制文件格式。                          | Windows                        |
| **Mach-O**       | macOS 和 iOS 的二进制文件格式。                                                              | macOS, iOS                     |

---

## 6. 指令架构到指令集到 ABI 的关系

| **层级**         | **作用**                                                                                     | **示例**                         |
|------------------|---------------------------------------------------------------------------------------------|---------------------------------|
| **指令架构 (ISA)**| 定义硬件支持的所有功能和操作（硬件层接口）。                                                    | x86, x86-64, ARM, RISC-V       |
| **指令集**       | 硬件支持的具体指令的集合，用于实现操作（软件和硬件交互的基本单元）。                              | x86 指令集、ARM 指令集          |
| **ABI**          | 软件与操作系统的接口，定义程序运行时如何使用硬件和系统功能。                                      | x86-64 System V ABI, AAPCS64   |

---

## 7. 总结

- **指令架构（ISA）** 定义了硬件支持的所有操作，是处理器设计的基础。
- **指令集** 是 ISA 的具体实现，定义了处理器支持的所有指令。
- **ABI** 是软件与操作系统的接口，定义了函数调用规则、二进制文件格式和系统调用方法。
- 它们共同构成了从硬件到软件的完整执行链，确保程序能够在指定硬件和操作系统环境中运行。

---

## 栈指针
栈顶 (高地址)
+------------------+ <- 调用前的 RSP
|  参数/返回地址   | 由函数调用时压入
+------------------+
|  临时变量        | SUB RSP, 0x28 分配的空间
+------------------+ <- 调用后的 RSP
栈底 (低地址)


| **调用约定**     | **参数传递方式**                                      | **返回值方式**     | **栈清理责任**         |
|------------------|-----------------------------------------------------|--------------------|-----------------------|
| **`__cdecl`**    | 所有参数通过栈，从右到左传递                          | 返回值在 `EAX/RAX`  | 调用者负责清理栈       |
| **`__stdcall`**  | 所有参数通过栈，从右到左传递                          | 返回值在 `EAX/RAX`  | 被调用者负责清理栈     |
| **`__fastcall`** | 参数优先通过寄存器（`ECX`, `EDX` 或 `RCX`, `RDX` 等）传递 | 返回值在 `EAX/RAX`  | 调用者负责清理栈       |
| **`__thiscall`** | 用于类成员函数，第一个参数（`this` 指针）通过寄存器 `ECX` | 返回值在 `EAX/RAX`  | 调用者负责清理栈       |

